<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warranty</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">

    <link rel="stylesheet" href="style.css">

</head>
<body>
   
 

    <!-- Toast Notification -->
    <div id="toast">
        Changes submitted successfully!
    </div>
    <br>
   
<!-- Container for filter menu and search input -->
<div id="filter-search-container">
    <!-- Hamburger Menu -->
    <div id="checkbox-menu">
        <button id="menu-toggle" type="button">‚ò∞ Filter</button>
        <div id="checkbox-container" class="hidden">
            <label for="filter-branch" class="filter-label">Filter by Field Technician:</label>
            <div id="filter-branch" class="checkbox-container"></div>
        </div>
    </div>

    <!-- Search Input -->
    <input type="text" id="search-input" placeholder="Search..." />

    <nav>
        <a href="https://airtable.com/appO21PVRA4Qa087I/shrIB8uJAdVkCfipw" class="nav-link active" target="_blank">Enter Record</a>
    </nav>
</div>

    
    <div class="table-wrapper">

    <div id="main-content" style="display: none;">
        <h2>Field Tech Review Needed</h2>
        <div class="scrollable-div">
            <table id="airtable-data">
                <thead>
                    <tr>
                        <th>Branch</th>
                        <th></th>
                        <th>Field Tech Assigned</th>
                        <th>Lot Number and Community</th>
                        <th>Address</th>
                        <th>Homeowner Name</th>
                        <th>Contact Email</th>
                        <th>Description of Issue</th>
                        <th>Pictures</th>
                        <th>DOW to be Completed</th>
                        <th>Materials Needed</th>
                        <th>Subcontractor</th>
                        <th>Subcontractor Payment</th>
                        <th>Subcontractor Not Needed</th>
                        <th>Subcontractor Not Needed</th>
                        <th>Billable/ Non Billable</th>
                        <th>Homeowner or Builder responsible</th>
                        <th>Billable Reason</th>
                        <th>Field Reviewed</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be injected here by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
    <br>
    <div class="trash-can" id="trash-can"></div>

    <div id="secoundary-content" style="display: none;">
        <h2>Scheduled Awaiting Field Technician</h2>
        <div class="scrollable-div">
            <table id="feild-data">
                <thead>
                    <tr>
                        <th>Branch</th>
                        <th></th>
                        <th>Field Tech Assigned</th>

                        <th>Lot Number and Community</th>
                        <th>Homeowner Name</th>
                        <th>Address</th>
                        <th>Description</th>
                        <th>Contact Email</th>
                        <th>Completed Pictures</th>
                        <th>DOW to be Completed</th>
                        <th>Job Completed</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be injected here by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

    <!-- Configuration for Airtable -->
    <script>
        window.env = {
            AIRTABLE_API_KEY: 'patXTUS9m8os14OO1.6a81b7bc4dd88871072fe71f28b568070cc79035bc988de3d4228d52239c8238',
            AIRTABLE_BASE_ID: 'appO21PVRA4Qa087I',
            AIRTABLE_TABLE_NAME: 'tbl6EeKPsNuEvt5yJ',
            AIRTABLE_TABLE_NAME2: 'tbl9SgC5wUi2TQuF7',
        };
        
        document.addEventListener("DOMContentLoaded", function () {
    function normalizeName(value) {
        return value
            .replace(/\u00A0/g, " ") // Replace non-breaking spaces
            .trim()
            .toLowerCase()
            .replace(/\s+/g, " ") // Normalize extra spaces
            .split(",") // Split multiple names
            .map(name => name.trim()) // Trim individual names
            .sort() // Sort names alphabetically
            .join(", "); // Join names back into a string
    }

    function mergeCellsByColumn(tableId, columnIndex) {
        console.log(`üîç Starting merge in table: ${tableId}, column index: ${columnIndex}`);

        let table = document.getElementById(tableId);
        if (!table) {
            console.warn(`‚ö†Ô∏è Table with ID '${tableId}' not found.`);
            return;
        }

        let rows = table.querySelectorAll("tbody tr");
        if (rows.length < 2) {
            console.warn(`‚ö†Ô∏è Not enough rows to merge in table '${tableId}'`);
            return;
        }

        let previousCell = null;
        let previousValue = "";
        let rowspan = 1;

        rows.forEach((row, index) => {
            let cell = row.cells[columnIndex];

            if (!cell) {
                console.warn(`‚ö†Ô∏è No cell found at row ${index + 1}, column ${columnIndex}`);
                return;
            }

            // Normalize and sort names before comparison
            let currentValue = normalizeName(cell.innerText);

            console.log(`üîé Checking row ${index + 1}: ${currentValue}`);

            if (previousCell && currentValue === previousValue) {
                rowspan++;
                previousCell.rowSpan = rowspan;
                cell.remove(); // Remove the duplicate cell completely
                console.log(`‚úÖ Merged row ${index + 1} with previous.`);
            } else {
                previousCell = cell;
                previousValue = currentValue;
                rowspan = 1;
            }
        });

        // Force table layout update
        table.style.display = "none";
        setTimeout(() => {
            table.style.display = "table";
        }, 50);
    }

    function waitForTableDataAndMerge(tableId, columnIndex) {
        let checkTableInterval = setInterval(() => {
            let table = document.getElementById(tableId);
            if (table) {
                let rows = table.querySelectorAll("tbody tr");
                
                if (rows.length > 1 && rows[0].cells.length > 1) {
                    console.log(`‚úÖ Data loaded in table '${tableId}'. Running merge function...`);
                    clearInterval(checkTableInterval);
                    mergeCellsByColumn(tableId, columnIndex);
                } else {
                    console.log(`‚è≥ Waiting for data in table '${tableId}'...`);
                }
            }
        }, 500); // Check every 500ms
    }

    // Run after tables have data
    waitForTableDataAndMerge("airtable-data", 2); // Third column (Index 2)
    waitForTableDataAndMerge("feild-data", 2); // Third column (Index 2)
});





        </script>
        
    <!-- JavaScript for interactivity -->
    <script src="script.js"></script>
    <script src="filter.js"></script>

   

</body>
</html>